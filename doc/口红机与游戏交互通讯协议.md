
#口红机主机程序



##基本定义

- 口红机主机程序（主要功能） （M）

	- 与服务器交互，获取支付订单信息
	- 与串口通讯，控制硬件
	- 与游戏接口
		- 管理游戏包安装
		- 管理游戏启动及处理游戏返回结果

- 游戏(G)
	- 使用主机程序参数启动游戏
	- 将游戏结果返回主机程序

	


##游戏发包命名规则


- 游戏包命名使用以下格式

		${pkg}-${versionName}-${versionCode}-release.apk
	
	如：
	
	|参数|数值|说明|
	|---|---|---|
	|pkg|com.cloudpoint.friendwealth|包名|
	|versionCode|370|版本号|
	|versionName|2.1.2.9|版本名|
	
	游戏发包名称：
	
		com.cloudpoint.friendwealth-2.1.2.9-370-release.apk
		


	

##口红机主机与游戏之间通讯方式


- 使用基于intent-broadcastreceiver的方式进行进程间通讯，目前已开发了个android类库
- 调用demo
- 启动游戏的方式（提供两种方式）
	- 口红机主机以intent方式启动activity(要求游戏设置gameid为category并获取相应加解密钥）
	- 口红机主机以intent方式请求service(游戏自启动service，要求游戏获取相应加解密钥）

- 数据传输

	- 数据传输格式
		- intent.action
		- intent.putByteArrayExtra('data_json',data)
		- intent.putStringExtra('data_md5',md5)
		- intent.addCategory('game_id') **activity方式**
		- **data**
			-  3des.encrypt(Message.getBytes('utf-8'))
			-  Message (GameStart,GameStartState,GameEnd,GameEndState)
		
		- **md5**
			- md5(data)
	
	- 主机程序至游戏(M->G)
		- **请求** 
			- intent.action="GameStart"
			
		- **响应**
			- intent.action="GameStartState"
					
		
	- 游戏至主机程序（G->M)
	 - **请求** 
			- intent.action="GameEnd"
						
		- **响应**
			- intent.action="GameEndState"


##		口红机主机与游戏接入及通讯流程

### 接入

- 口红机提供游戏id及加解密密钥与接入库包
	- **game_id** 游戏标识
	- **des_key** 3Des加解密钥
	- **接入库包**
- 游戏
	- 使用game_id,des_key
	- 游戏以activity方式启动时，将game_id加入intent-fitler
	- 游戏以服务方式启动时，需要游戏提供服务启动方式

###通讯流程（activity）

- 口红机根据用户支付及服务器参数设置游戏时间及游戏难度，并使用启动activity
- 游戏根据设置参数启动游戏
- 游戏结束，调用intent发出游戏结果

###通讯流程（service）

- 口红机启动游戏服务
- 根据用户支付及服务器参数设置游戏时间及游戏难度，将发出intent
- 游戏根据设置参数启动游戏
- 游戏结束，调用intent发出游戏结果


	
		


##主要消息(Message)

- 启动游戏 (M->G)
	- 请求
	**GameStart**
	
	|参数|类型|说明|
	|---|---|---|
	|order_id|string|订单号|
	|game_id|string|游戏序号|
	|timeout|int|游戏时间|
	|probility|int|游戏难度|
	|timestamp|long|时间戳|
	
	- 响应
	**GameState**
	
	|参数|类型|说明|
	|---|---|---|
	|state|int|状态|
	|msg|string|信息|
	|order_id|string|订单号|
	|game_id|string|游戏序号|
	|timestamp|long|时间戳|

	
	
	
	
- 游戏结束返回结果 (G->M)

- 请求
	**GameEnd**
	
	|参数|类型|说明|
	|---|---|---|
	|order_id|string|订单号|
	|game_id|string|游戏序号|
	|succeed|int|游戏是否完成|
	|time|int|游戏玩的时间|
	|timestamp|long|时间戳|
	
	- 响应
	**GameState**
	
	|参数|类型|说明|
	|---|---|---|
	|state|int|状态|
	|msg|string|信息|
	|order_id|string|订单号|
	|game_id|string|游戏序号|
	|timestamp|long|时间戳|




